// CLI for memory management:
// npm i -D climem 

// Node built-in:
// [leandropassoslpkyrius@LeandroPassos 02-memleak-events (main âœ—)]$ node 
// Welcome to Node.js v21.7.1.
// Type ".help" for more information.
// > process.memoryUsage()
// {
//   rss: 41353216, (resident set site - memory main machine is using)
//   heapTotal: 6275072, (allocated)
//   heapUsed: 5097536,
//   external: 2191985,
//   arrayBuffers: 10535
// }
// > 

// For load tests
// npm i -D autocannon
// package.json
// "test": "npm autocannon -c 100 -d 30 -p 10 http://localhost:3000"
//  -c users -d time in seconds, -p pipeline in 10


// Analyse and find the line with the memory leak:
// npm i -D 0x

// even more powefull
// npm i -D clinic
// npx clinic --help

// to check if are there any process using the port:
// lsof -i :3000 

import { createServer } from 'http'
import Events from 'events'
import { randomBytes } from 'crypto'

const myEvent = new Events()

function getBytes() {
    return randomBytes(10000)
}

function onData() {
    getBytes()
    const items = []
    // setInterval(function myInterval() { items.push(Date.now()) })
}

myEvent.on('data', onData)
createServer(function handler(request, response) {
    // myEvent.on('data', onData) //  this line should be 2 lines above, before the createServer()

    myEvent.emit('data', Date.now())

    response.end('ok ğŸ‘')
}).listen(3000, () => console.log('running at 3000'))


// while everything was ok:
// [leandropassoslpkyrius@LeandroPassos 02-memleak-events (main âœ—)]$ npm t

// > 02-memleak-events@1.0.0 test
// > npx autocannon -c 100 -d 30 -p 10 http://localhost:3000

// Running 30s test @ http://localhost:3000
// 100 connections with 10 pipelining factor


// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Stat    â”‚ 2.5% â”‚ 50%  â”‚ 97.5% â”‚ 99%   â”‚ Avg     â”‚ Stdev   â”‚ Max    â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Latency â”‚ 3 ms â”‚ 8 ms â”‚ 13 ms â”‚ 21 ms â”‚ 7.41 ms â”‚ 5.65 ms â”‚ 353 ms â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Stat      â”‚ 1%      â”‚ 2.5%    â”‚ 50%     â”‚ 97.5%   â”‚ Avg       â”‚ Stdev     â”‚ Min     â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Req/Sec   â”‚ 49,535  â”‚ 49,535  â”‚ 135,679 â”‚ 139,647 â”‚ 126,932.8 â”‚ 20,286.43 â”‚ 49,522  â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Bytes/Sec â”‚ 6.39 MB â”‚ 6.39 MB â”‚ 17.5 MB â”‚ 18 MB   â”‚ 16.4 MB   â”‚ 2.62 MB   â”‚ 6.39 MB â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// Req/Bytes counts sampled once per second.
// # of samples: 30

// 3809k requests in 30.03s, 491 MB read


// When we forced the memory leak:
// [leandropassoslpkyrius@LeandroPassos 02-memleak-events (main âœ—)]$ npm t

// > 02-memleak-events@1.0.0 test
// > npx autocannon -c 100 -d 30 -p 10 http://localhost:3000

// Running 30s test @ http://localhost:3000
// 100 connections with 10 pipelining factor


// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Stat    â”‚ 2.5% â”‚ 50%    â”‚ 97.5%   â”‚ 99%     â”‚ Avg       â”‚ Stdev      â”‚ Max     â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Latency â”‚ 6 ms â”‚ 290 ms â”‚ 4301 ms â”‚ 4464 ms â”‚ 747.97 ms â”‚ 1061.87 ms â”‚ 6088 ms â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
// â”‚ Stat      â”‚ 1%  â”‚ 2.5% â”‚ 50% â”‚ 97.5%  â”‚ Avg     â”‚ Stdev   â”‚ Min  â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Req/Sec   â”‚ 0   â”‚ 0    â”‚ 0   â”‚ 1,525  â”‚ 104.17  â”‚ 287.9   â”‚ 31   â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Bytes/Sec â”‚ 0 B â”‚ 0 B  â”‚ 0 B â”‚ 197 kB â”‚ 13.4 kB â”‚ 37.1 kB â”‚ 4 kB â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

// Req/Bytes counts sampled once per second.
// # of samples: 30

// 160k requests in 30.12s, 403 kB read
// 17k errors (2k timeouts)